# =============================================================
# Отключаем ненужные сервисы
# =============================================================

---
- name: Disable unnecessary services
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: stopped
    enabled: false
  loop:
    - apport
    - whoopsie
    - avahi-daemon
    - cups
    - bluetooth
  ignore_errors: true  # некоторых сервисов может не быть

- name: Remove unnecessary packages
  ansible.builtin.apt:
    name:
      - telnet
      - rsh-client
      - talk
      - ntalk
    state: absent
    purge: true

- name: Ensure only SSH is allowed for remote access
  ansible.builtin.apt:
    name: openssh-server
    state: present

- name: Harden SSH config
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
  loop:
    - { regexp: "^#?PermitRootLogin",      line: "PermitRootLogin no" }
    - { regexp: "^#?PasswordAuthentication", line: "PasswordAuthentication no" }
    - { regexp: "^#?X11Forwarding",        line: "X11Forwarding no" }
    - { regexp: "^#?MaxAuthTries",         line: "MaxAuthTries 3" }
    - { regexp: "^#?AllowTcpForwarding",   line: "AllowTcpForwarding no" }
    - { regexp: "^#?ClientAliveInterval",  line: "ClientAliveInterval 300" }
    - { regexp: "^#?ClientAliveCountMax",  line: "ClientAliveCountMax 2" }
  notify: restart sshd

- name: Install fail2ban
  ansible.builtin.apt:
    name: fail2ban
    state: present
    update_cache: true

- name: Configure fail2ban for SSH
  ansible.builtin.copy:
    dest: /etc/fail2ban/jail.d/sshd.conf
    content: |
      [sshd]
      enabled  = true
      port     = ssh
      maxretry = 3
      bantime  = 3600
      findtime = 600
    mode: "0644"

- name: Enable fail2ban
  ansible.builtin.systemd:
    name: fail2ban
    enabled: true
    state: started
