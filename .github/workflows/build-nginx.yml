
# =============================================================
# GitHub Actions: сборка Nginx AMI
# Запуск: вручную с выбором версии и региона
# =============================================================

name: Build Nginx AMI

on:
  workflow_dispatch:
    inputs:
      nginx_version:
        description: "Версия Nginx (latest = автоопределение)"
        required: true
        default: "latest"
        type: choice
        options:
          - "latest"
          - "1.26"
          - "1.24"
      aws_region:
        description: "AWS регион"
        required: true
        default: "us-east-1"
        type: choice
        options:
          - us-east-1
          - eu-west-1
          - ap-southeast-1
      build_env:
        description: "Окружение"
        required: true
        default: "prod"
        type: choice
        options:
          - prod
          - staging
      dry_run:
        description: "Dry run (только validate, без сборки)"
        type: boolean
        default: false

env:
  PACKER_VERSION: "1.11.0"

jobs:
  build:
    name: "Nginx ${{ inputs.nginx_version }} -> ${{ inputs.aws_region }}"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ── Резолвим версию если выбран latest ───────────────
      - name: Resolve Nginx version
        id: version
        run: |
          if [ "${{ inputs.nginx_version }}" = "latest" ]; then
            RESOLVED=$(curl -s https://nginx.org/en/download.html \
              | grep -oP 'nginx-\K[0-9]+\.[0-9]+\.[0-9]+(?=\.tar\.gz)' \
              | awk -F. '$2 % 2 == 0' \
              | sort -V | tail -1)
            echo "Resolved latest nginx version: $RESOLVED"
          else
            RESOLVED="${{ inputs.nginx_version }}"
          fi
          echo "nginx_version=$RESOLVED" >> $GITHUB_OUTPUT

      # ── AWS credentials ──────────────────────────────────
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.aws_region }}

      # ── Установка инструментов ───────────────────────────
      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Install Ansible
        run: |
          pip install ansible==10.3.0
          ansible --version

      # ── Packer init ──────────────────────────────────────
      - name: Packer init
        run: packer init packer/nginx.pkr.hcl

      # ── Packer validate ──────────────────────────────────
      - name: Packer validate
        run: |
          packer validate \
            -var "nginx_version=${{ steps.version.outputs.nginx_version }}" \
            -var "aws_region=${{ inputs.aws_region }}" \
            -var "build_env=${{ inputs.build_env }}" \
            packer/nginx.pkr.hcl

      # ── Packer build ─────────────────────────────────────
      - name: Packer build
        if: ${{ inputs.dry_run == false }}
        id: build
        run: |
          packer build \
            -var "nginx_version=${{ steps.version.outputs.nginx_version }}" \
            -var "aws_region=${{ inputs.aws_region }}" \
            -var "build_env=${{ inputs.build_env }}" \
            packer/nginx.pkr.hcl 2>&1 | tee build.log

          AMI_ID=$(jq -r '.builds[-1].artifact_id' packer-manifest.json | cut -d: -f2)
          echo "ami_id=$AMI_ID" >> $GITHUB_OUTPUT
          echo "## AMI Built" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| AMI ID | \`$AMI_ID\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ inputs.aws_region }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Nginx | ${{ steps.version.outputs.nginx_version }} |" >> $GITHUB_STEP_SUMMARY

      - name: Dry run summary
        if: ${{ inputs.dry_run == true }}
        run: |
          echo "## Dry Run - только валидация" >> $GITHUB_STEP_SUMMARY
          echo "Версия Nginx: ${{ steps.version.outputs.nginx_version }}" >> $GITHUB_STEP_SUMMARY
          echo "Сборка не запускалась. Packer validate прошёл успешно." >> $GITHUB_STEP_SUMMARY

      # ── Артефакты ────────────────────────────────────────
      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "nginx-${{ steps.version.outputs.nginx_version }}-${{ inputs.aws_region }}-log"
          path: |
            build.log
            packer-manifest.json
          if-no-files-found: ignore
          retention-days: 30
