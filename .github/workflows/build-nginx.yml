# =============================================================
# GitHub Actions: ÑĞ±Ğ¾Ñ€ĞºĞ° Nginx AMI
# Ğ—Ğ°Ğ¿ÑƒÑĞº: Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ¾Ğ¼ Ğ²ĞµÑ€ÑĞ¸Ğ¸ Ğ¸ Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½Ğ°
# =============================================================
 
name: Build Nginx AMI
 
on:
  workflow_dispatch:
    inputs:
      nginx_version:
        description: "Ğ’ĞµÑ€ÑĞ¸Ñ Nginx"
        required: true
        default: "1.26"
        type: choice
        options:
          - "1.26"
          - "1.24"
      aws_region:
        description: "AWS Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½"
        required: true
        default: "us-east-1"
        type: choice
        options:
          - us-east-1
          - eu-west-1
          - ap-southeast-1
      build_env:
        description: "ĞĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ"
        required: true
        default: "prod"
        type: choice
        options:
          - prod
          - staging
      dry_run:
        description: "Dry run (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ validate, Ğ±ĞµĞ· ÑĞ±Ğ¾Ñ€ĞºĞ¸)"
        type: boolean
        default: false
 
env:
  PACKER_VERSION: "1.11.0"
 
jobs:
  build:
    name: "Nginx ${{ inputs.nginx_version }} â†’ ${{ inputs.aws_region }}"
    runs-on: ubuntu-latest
 
    steps:
      - name: Checkout
        uses: actions/checkout@v4
 
      # â”€â”€ AWS credentials â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ inputs.aws_region }}
 
      # â”€â”€ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¸Ğ½ÑÑ‚Ñ€ÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}
 
      - name: Install Ansible
        run: |
          pip install ansible==10.3.0
          ansible --version
 
      # â”€â”€ Packer init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Packer init
        run: packer init packer/nginx.pkr.hcl
 
      # â”€â”€ Packer validate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Packer validate
        run: |
          packer validate \
            -var "nginx_version=${{ inputs.nginx_version }}" \
            -var "aws_region=${{ inputs.aws_region }}" \
            -var "build_env=${{ inputs.build_env }}" \
            packer/nginx.pkr.hcl
 
      # â”€â”€ Packer build â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Packer build
        if: ${{ inputs.dry_run == false }}
        id: build
        run: |
          packer build \
            -var "nginx_version=${{ inputs.nginx_version }}" \
            -var "aws_region=${{ inputs.aws_region }}" \
            -var "build_env=${{ inputs.build_env }}" \
            packer/nginx.pkr.hcl 2>&1 | tee build.log
          
          # Ğ˜Ğ·Ğ²Ğ»ĞµĞºĞ°ĞµĞ¼ AMI ID Ğ¸Ğ· Ğ¼Ğ°Ğ½Ğ¸Ñ„ĞµÑÑ‚Ğ°
          AMI_ID=$(jq -r '.builds[-1].artifact_id' packer-manifest.json | cut -d: -f2)
          echo "ami_id=$AMI_ID" >> $GITHUB_OUTPUT
          echo "## âœ… AMI Built" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| AMI ID | `$AMI_ID` |" >> $GITHUB_STEP_SUMMARY
          echo "| Region | ${{ inputs.aws_region }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Nginx | ${{ inputs.nginx_version }} |" >> $GITHUB_STEP_SUMMARY
 
      - name: Dry run summary
        if: ${{ inputs.dry_run == true }}
        run: |
          echo "## ğŸ” Dry Run â€” Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ" >> $GITHUB_STEP_SUMMARY
          echo "Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ğ½Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°Ğ»Ğ°ÑÑŒ. Packer validate Ğ¿Ñ€Ğ¾ÑˆÑ‘Ğ» ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾." >> $GITHUB_STEP_SUMMARY
 
      # â”€â”€ ĞÑ€Ñ‚ĞµÑ„Ğ°ĞºÑ‚Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: "nginx-${{ inputs.nginx_version }}-${{ inputs.aws_region }}-log"
          path: |
            build.log
            packer-manifest.json
          if-no-files-found: ignore
          retention-days: 30
 
